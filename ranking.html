<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>อันดับ 5 โรคผู้ป่วย</title>
<style>
body { margin:0; font-family:sans-serif; background: linear-gradient(to right, rgb(55,194,115), rgb(183,226,196)); }
header { text-align:center; padding:30px 20px; }
main { padding:20px; max-width:900px; margin:auto; background-color: rgba(255,255,255,0.9); border-radius:12px; }
label { font-weight:bold; margin-right:10px; }
select { padding:6px 10px; border-radius:6px; border:1px solid #333; margin-right:10px; }
table { width:100%; border-collapse: collapse; margin-top:15px; display:block; overflow-x:auto; }
th, td { padding:12px; text-align:center; border:1px solid #333; white-space: nowrap; }
th { background-color: rgb(4,44,24); color:white; }
tr:nth-child(even) { background-color: rgba(0,0,0,0.05); }
a.back { display:inline-block; margin-bottom:15px; text-decoration:none; color:white; background:rgb(4,44,24); padding:8px 16px; border-radius:6px; }
a.back:hover { background:rgb(22,90,50); }
#tableContainer table { animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
.spinner {
  border: 4px solid rgba(0,0,0,0.1);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  border-left-color: #333;
  animation: spin 1s linear infinite;
  display:inline-block;
  vertical-align: middle;
}
@keyframes spin { 100% { transform: rotate(360deg); } }
</style>
</head>
<body>
<header>
<h1>อันดับ 5 โรคผู้ป่วย</h1>
</header>
<main>
<a href="index.html" class="back">&larr; กลับหน้าหลัก</a>

<div style="margin-bottom:20px;">
  <label for="patientType">เลือกประเภทผู้ป่วย:</label>
  <select id="patientType">
    <option value="opd">ผู้ป่วยนอก (OPD)</option>
    <option value="ipd">ผู้ป่วยใน (IPD)</option>
  </select>

  <label for="yearSelect">เลือกปี:</label>
  <select id="yearSelect">
    <option value="2566">2566</option>
    <option value="2567">2567</option>
    <option value="2568" selected>2568</option>
  </select>
</div>

<div id="tableContainer">
  <span class="spinner"></span> กำลังโหลดข้อมูล...
</div>

<!-- PapaParse -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<script>
// ====== Static Data ======
const staticData = {
  opd: {
    "2566": [
      ["HT","5099"],
      ["DM","4173"],
      ["URI","3193"],
      ["Covid-19","1281"],
      ["Dyspepsia","1101"]
    ],
    "2567": [
      ["CKD5","14810"],
      ["HT","11922"],
      ["DM","11370"],
      ["Dyspepsia","2935"],
      ["URI","2786"]
    ]
  },
  ipd: {
    "2566": [
      ["Pneumonia","103"],
      ["Head Injury","93"],
      ["COPD","55"],
      ["AGE","54"],
      ["CHF","50"]
    ],
    "2567": [
      ["Pneumonia","416"],
      ["Sepsis","377"],
      ["Senile cataract","311"],
      ["Stroke","229"],
      ["Intracranail injury","211"]
    ]
  }
};

// ====== CSV Links ปี 2568 ======
const csvLinks2568 = {
  opd_general: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTfILYO-grwMvz_XxbBiMtN0xxVdz8_SNy0hWPt3UTdW5u0PvXGI2f96TKn-cuJ_3yuVlnL9mzWXjGv/pub?gid=0&single=true&output=csv",
  opd_ncd: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ1JyYvEW-GNlsmuIWS3mQ-QYzBRxstG4L90m_egN0UG61ZaCcyTaWQTfU4wkIWZZj8xpxK8u6mpgMX/pub?output=csv",
  ipd: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRRguUkbI1WPemYRAI7QCJMgX9Tbvw961umVNShBwROZlWDT0GbxQy3IqMd4dZAZmcnEE4jMyOkhwMp/pub?gid=0&single=true&output=csv"
};

// ====== สร้าง HTML Table ======
function renderTable(title, rows){
  let html = `<h3 style="margin-top:25px;">${title}</h3>`;
  html += `<table>
             <thead>
               <tr>
                 <th>อันดับ</th>
                 <th>ชื่อโรค</th>
                 <th>จำนวนผู้ป่วย</th>
               </tr>
             </thead>
             <tbody>`;
  rows.forEach((r,i)=>{
    html += `<tr>
               <td>${i+1}</td>
               <td>${r[0]}</td>
               <td>${Number(r[1]).toLocaleString()}</td>
             </tr>`;
  });
  html += `</tbody></table>`;
  return html;
}

// ====== แปลง CSV → Table ด้วย PapaParse และเลือก 5 อันดับ ======
function renderCSVtoTable(title, csvText){
  const parsed = Papa.parse(csvText, {header:true, skipEmptyLines:true});
  let rows = parsed.data.map(r => [r['ชื่อโรค'] || r['Disease'] || r[Object.keys(r)[1]], 
                                   r['จำนวนผู้ป่วย'] || r['Count'] || r[Object.keys(r)[2]]]);
  // ลบ row ที่ไม่มีข้อมูล
  rows = rows.filter(r=>r[0] && r[1]);
  // แปลงจำนวนเป็นตัวเลขและ sort ลดหลั่น
  rows = rows.map(r=>[r[0], Number(r[1].toString().replace(/,/g,''))])
             .sort((a,b)=>b[1]-a[1])
             .slice(0,5); // เอา 5 อันดับแรก
  return renderTable(title, rows);
}

// ====== โหลดข้อมูล ======
function loadTable(){
  const type = document.getElementById("patientType").value;
  const year = document.getElementById("yearSelect").value;
  const container = document.getElementById("tableContainer");
  container.innerHTML = `<span class="spinner"></span> กำลังโหลดข้อมูล...`;

  if(year === "2568"){
    if(type === "opd"){
      // โหลด 2 ตาราง OPD
      Promise.all([
        fetch(csvLinks2568.opd_general).then(r=>r.text()),
        fetch(csvLinks2568.opd_ncd).then(r=>r.text())
      ])
      .then(([generalCSV, ncdCSV])=>{
        container.innerHTML =
          renderCSVtoTable("OPD ทั่วไป", generalCSV) +
          renderCSVtoTable("OPD NCD", ncdCSV);
      })
      .catch(()=> container.innerHTML = "⚠️ โหลดข้อมูลไม่สำเร็จ");
    } else {
      // โหลด IPD
      fetch(csvLinks2568.ipd)
        .then(r=>r.text())
        .then(csv => container.innerHTML = renderCSVtoTable("IPD", csv))
        .catch(()=> container.innerHTML = "⚠️ โหลดข้อมูลไม่สำเร็จ");
    }
  } else {
    // Static data
    container.innerHTML = renderTable(type.toUpperCase(), staticData[type][year]);
  }
}

// เรียกโหลดครั้งแรก
loadTable();

// เมื่อ dropdown เปลี่ยนค่า
document.getElementById("patientType").addEventListener("change", loadTable);
document.getElementById("yearSelect").addEventListener("change", loadTable);
</script>
</main>
</body>
</html>
